import { useEffect, useState } from 'react'
import { createPortal } from 'react-dom'
import { format } from 'date-fns'
import { useNavigate } from 'react-router-dom'
import {
    Calendar,
    Clock,
    User,
    Phone,
    Search,
    Filter,
    Plus,
    MoreVertical,
    CheckCircle2,
    XCircle,
    AlertCircle,
    Loader2,
    X,
    LayoutList,
    Calendar as CalendarIcon,
    RefreshCw,
    Settings,
    ChevronRight,
    Trash2,
    MessageCircle,
} from 'lucide-react'
import { cn, formatPhoneNumber, getStatusColor, getStatusLabel } from '@/lib/utils'
import { supabase } from '@/lib/supabase'
import { useAuth } from '@/contexts/AuthContext'
import { CalendarView, CalendarEvent } from '@/components/calendar/CalendarView'
import { ClinicalRecordForm } from '@/components/patients/ClinicalRecordForm'
import { PatientForm } from '@/components/patients/PatientForm'
import { Database } from '@/types/database'

type Patient = Database['public']['Tables']['patients']['Row']

interface Appointment {
    id: string
    patient_name: string
    phone_number: string
    service: string
    appointment_date: string
    appointment_time: string
    status: 'pending' | 'confirmed' | 'cancelled' | 'completed'
    notes: string | null
    google_event_id?: string | null
    professional_id?: string | null
}

interface ClinicProfessional {
    member_id: string
    first_name: string | null
    last_name: string | null
    email: string
    role: string
    job_title: string | null
    specialty: string | null
    color: string | null
    working_hours: Record<string, { enabled: boolean; start: string; end: string }> | null
}

const tabs = [
    { id: 'all', label: 'Todas' },
    { id: 'pending', label: 'Pendientes' },
    { id: 'confirmed', label: 'Confirmadas' },
    { id: 'completed', label: 'Completadas' },
]

export default function Appointments() {
    const { user, profile, session } = useAuth()
    const navigate = useNavigate()
    const [appointments, setAppointments] = useState<Appointment[]>([])
    const [loading, setLoading] = useState(true)
    const [activeTab, setActiveTab] = useState('all')
    const [searchQuery, setSearchQuery] = useState('')

    // Modal state
    const [showModal, setShowModal] = useState(false)
    const [saving, setSaving] = useState(false)
    const [editingId, setEditingId] = useState<string | null>(null)
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const [googleEvents] = useState<CalendarEvent[]>([])
    const [newAppointment, setNewAppointment] = useState({
        patient_name: '',
        phone_number: '',
        service: '',
        appointment_date: '',
        appointment_time: '',
        notes: '',
        professional_id: ''
    })
    const [services, setServices] = useState<any[]>([])
    const [professionals, setProfessionals] = useState<ClinicProfessional[]>([])
    const [professionalFilter, setProfessionalFilter] = useState<string>('all')

    // CRM Integration State
    const [showRecordModal, setShowRecordModal] = useState(false)
    const [showPatientModal, setShowPatientModal] = useState(false)
    const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)
    const [foundPatient, setFoundPatient] = useState<Patient | null>(null)

    // Fetch services and professionals
    useEffect(() => {
        const fetchServices = async () => {
            if (!profile?.clinic_id) return
            const { data } = await supabase
                .from('services')
                .select('*')
                .eq('clinic_id', profile.clinic_id)
                .order('name', { ascending: true })
            if (data) setServices(data)
        }
        const fetchProfessionals = async () => {
            if (!profile?.clinic_id) return
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            const { data } = await (supabase as any).rpc('get_clinic_professionals', {
                p_clinic_id: profile.clinic_id
            })
            if (data) setProfessionals(data)
        }
        fetchServices()
        fetchProfessionals()
    }, [profile?.clinic_id])

    // Date filter state
    const [dateFilter, setDateFilter] = useState<'all' | 'today' | 'tomorrow' | 'week'>('all')
    const [showDatePicker, setShowDatePicker] = useState(false)
    const [showFilters, setShowFilters] = useState(false)
    const [viewMode, setViewMode] = useState<'list' | 'calendar'>('list')

    // Fetch appointments function
    const fetchAppointments = async () => {
        if (!user || !profile?.clinic_id) {
            setLoading(false)
            return
        }

        try {
            const { data, error } = await supabase
                .from('appointments')
                .select('*')
                .eq('clinic_id', profile.clinic_id)
                .order('appointment_date', { ascending: false })

            if (error) throw error
            console.log('Fetched appointments:', data)

            setAppointments(data || [])
        } catch (error) {
            console.error('Error fetching appointments:', error)
        } finally {
            setLoading(false)
        }
    }

    useEffect(() => {
        fetchAppointments()
    }, [user, profile])

    // Update appointment status
    const updateAppointmentStatus = async (id: string, newStatus: 'confirmed' | 'cancelled' | 'completed') => {
        try {
            // Optimistic update
            const appointment = appointments.find(a => a.id === id)
            if (!appointment) return

            setAppointments(appointments.map(a =>
                a.id === id ? { ...a, status: newStatus } : a
            ))

            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            const { error } = await (supabase as any)
                .from('appointments')
                .update({ status: newStatus })
                .eq('id', id)

            if (error) throw error

            // Handle "Completed" status - CRM Integration
            if (newStatus === 'completed') {
                // 1. Find patient by phone number
                const cleanPhone = appointment.phone_number.replace(/\D/g, '')

                // Try exact match first, then formatted
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                const { data: patients, error: patientError } = await (supabase as any)
                    .from('patients')
                    .select('*')
                    .eq('clinic_id', profile!.clinic_id)
                    .or(`phone_number.eq.${cleanPhone},phone_number.eq.${appointment.phone_number}`)
                    .limit(1)

                if (patientError) {
                    console.error('Error finding patient:', patientError)
                    return
                }

                const patient = patients && patients.length > 0 ? patients[0] : null
                setSelectedAppointment(appointment)

                if (patient) {
                    // Patient found
                    setFoundPatient(patient)
                    if (confirm(`Cita completada. ¿Deseas crear un registro clínico para ${patient.name}?`)) {
                        setShowRecordModal(true)
                    }
                } else {
                    // Patient not found
                    setFoundPatient(null)
                    if (confirm(`Cita completada. El paciente "${appointment.patient_name}" no existe en la base de datos. ¿Deseas crearlo ahora para agregar el registro clínico?`)) {
                        // eslint-disable-next-line @typescript-eslint/no-explicit-any
                        const { data: appointmentData } = await (supabase as any)
                            .from('appointments')
                            .select(`
                        *,
                        patient:patients(name)
                    `)
                            .eq('id', id)
                            .single()

                        if (appointmentData?.patient) {
                            // eslint-disable-next-line @typescript-eslint/no-explicit-any
                            const patientName = (appointmentData as any).patient.name
                            if (confirm(`Cita completada. ¿Deseas crear un registro clínico para ${patientName}?`)) {
                                // Redirect to patient details with open modal
                                // We need patient ID, which is on the appointment
                                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                                const patientId = (appointmentData as any).patient_id
                                navigate(`/patients/${patientId}?action=new_record`)
                            }
                        }
                    }
                }
            }
            // Sync with Google Calendar
            if (newStatus === 'cancelled') {
                if (appointment?.google_event_id) {
                    console.log('Cancelling Google Event:', appointment.google_event_id)
                    supabase.functions.invoke('delete-google-event', {
                        body: { google_event_id: appointment.google_event_id }
                    }).then(({ error }) => {
                        if (error) console.error('Error deleting Google event:', error)
                        else console.log('Google event deleted successfully')
                    }).catch(err => console.error('Error deleting Google event:', err))
                }
            }

        } catch (error) {
            console.error('Error updating status:', error)
            fetchAppointments()
        }
    }

    // Send WhatsApp Reminder
    const handleSendReminder = async (appointment: any) => {
        if (!confirm(`¿Enviar recordatorio a ${appointment.patient_name}?`)) return

        try {
            const { error } = await supabase.functions.invoke('send-whatsapp-reminder', {
                body: { appointment_id: appointment.id }
            })

            if (error) throw error

            alert('Recordatorio enviado correctamente')
        } catch (error: any) {
            console.error('Error sending reminder:', error)
            alert('Error al enviar recordatorio: ' + (error.message || 'Desconocido'))
        }
    }

    // Send Satisfaction Survey
    const handleSendSurvey = async (appointment: Appointment) => {
        if (!confirm(`¿Enviar encuesta de satisfacción a ${appointment.patient_name}?`)) return

        try {
            const { error } = await supabase.functions.invoke('send-whatsapp-survey', {
                body: { appointment_id: appointment.id }
            })

            if (error) throw error

            alert('Encuesta enviada correctamente')
        } catch (error: any) {
            console.error('Error sending survey:', error)
            alert('Error al enviar encuesta: ' + (error.message || 'Desconocido'))
        }
    }


    // Fetch Google Calendar Events via Edge Function
    const fetchGoogleEvents = async () => {
        // Disabled by user request
        return
    }

    useEffect(() => {
        if (session?.user) {
            fetchGoogleEvents()
        }
    }, [session?.user?.id])

    const handleSaveAppointment = async (e: React.FormEvent) => {
        e.preventDefault()
        if (!user || !profile) return

        setSaving(true)
        try {
            // Construct Date from local inputs to get correct UTC time
            const [year, month, day] = newAppointment.appointment_date.split('-').map(Number)
            const [hours, minutes] = newAppointment.appointment_time.split(':').map(Number)
            const localDate = new Date(year, month - 1, day, hours, minutes)
            const appointmentDate = localDate.toISOString()

            let appointmentId = editingId
            let googleEventId = null

            if (editingId) {
                // UPDATE existing appointment
                // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unused-vars
                const { error } = await (supabase as any)
                    .from('appointments')
                    .update({
                        patient_name: newAppointment.patient_name,
                        phone_number: newAppointment.phone_number,
                        service: newAppointment.service,
                        appointment_date: appointmentDate,
                        notes: newAppointment.notes,
                        // Don't update clinic_id or user_id
                    })
                    .eq('id', editingId)
                    .select()
                    .single()

                if (error) throw error

                // Get the existing google_event_id to update it
                const existingAppt = appointments.find(a => a.id === editingId)
                googleEventId = existingAppt?.google_event_id

            } else {
                // CREATE new appointment
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                const { data, error } = await (supabase as any)
                    .from('appointments')
                    .insert([
                        {
                            clinic_id: profile.clinic_id,
                            patient_name: newAppointment.patient_name,
                            phone_number: newAppointment.phone_number,
                            service: newAppointment.service,
                            appointment_date: appointmentDate,
                            status: 'confirmed',
                            notes: newAppointment.notes,
                            professional_id: newAppointment.professional_id || null,
                        },
                    ])
                    .select()
                    .single()

                if (error) throw error
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                appointmentId = (data as any).id
            }

            // Sync with Google Calendar (Create or Update)
            let durationMinutes = 60
            const selectedServiceObj = services.find(s => s.name === newAppointment.service)
            if (selectedServiceObj) {
                durationMinutes = selectedServiceObj.duration
            }

            const endDate = new Date(new Date(appointmentDate).getTime() + durationMinutes * 60 * 1000).toISOString()

            if (editingId && googleEventId) {
                // Update Google Event
                const { error: googleError } = await supabase.functions.invoke('update-google-event', {
                    body: {
                        google_event_id: googleEventId,
                        title: `${newAppointment.patient_name} - ${newAppointment.service}`,
                        description: newAppointment.notes,
                        start: appointmentDate,
                        end: endDate
                    }
                })

                if (googleError) {
                    console.error('Error syncing update to Google Calendar:', googleError)
                    // alert(`Error debug: ${JSON.stringify(googleError)}`)
                } else {
                    console.log('Google Calendar event updated')
                }
            } else if (!editingId || (editingId && !googleEventId)) {
                // ...
                const { data: googleData, error: googleError } = await supabase.functions.invoke('create-google-event', {
                    body: {
                        title: `${newAppointment.patient_name} - ${newAppointment.service}`,
                        description: newAppointment.notes,
                        start: appointmentDate,
                        end: endDate,
                    },
                })

                if (googleError) {
                    // This handles network/transport errors (like offline or CORS)
                    console.error('Network/Transport error creating Google Calendar event:', googleError)
                    // alert(`Error de conexión: ${JSON.stringify(googleError)}`)
                } else if (!googleData?.success) {
                    // This handles API/Logical errors returned as 200 OK { success: false }
                    console.error('Logic error creating Google Calendar event:', googleData)
                    // alert(`Error de sincronización: ${googleData?.error || 'Desconocido'}\nDetalles: ${JSON.stringify(googleData?.details)}`)
                } else if (googleData?.event_id && appointmentId) {
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    await (supabase as any)
                        .from('appointments')
                        .update({ google_event_id: googleData.event_id })
                        .eq('id', appointmentId)

                    console.log('Synced with Google Calendar:', googleData.event_id)
                }
            }

            setShowModal(false)
            setNewAppointment({
                patient_name: '',
                phone_number: '',
                service: '',
                appointment_date: '',
                appointment_time: '',
                notes: '',
                professional_id: ''
            })
            setEditingId(null)

            // Refresh list
            fetchAppointments()

        } catch (error) {
            console.error('Error creating appointment:', error)
        } finally {
            setSaving(false)
        }
    }

    const handleDeleteAppointment = async (appointment: Appointment) => {
        if (!confirm('¿Estás seguro de que quieres eliminar esta cita?')) return

        try {
            // 1. Delete from Supabase
            const { error } = await supabase
                .from('appointments')
                .delete()
                .eq('id', appointment.id)

            if (error) throw error

            // 2. Remove from local state immediately
            setAppointments(appointments.filter(a => a.id !== appointment.id))

            // 3. Delete from Google Calendar if linked
            if (appointment.google_event_id) {
                supabase.functions.invoke('delete-google-event', {
                    body: { google_event_id: appointment.google_event_id }
                }).then(({ error }) => {
                    if (error) console.error('Error deleting Google event:', error)
                    else console.log('Google event deleted')
                }).catch(err => console.error('Error deleting Google event:', err))
            }

        } catch (error) {
            console.error('Error deleting appointment:', error)
            alert('Error al eliminar la cita')
        }
    }

    const filteredAppointments = appointments.filter((appointment) => {
        const matchesSearch =
            appointment.patient_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            appointment.service.toLowerCase().includes(searchQuery.toLowerCase()) ||
            appointment.phone_number.includes(searchQuery)

        const matchesTab = activeTab === 'all' || appointment.status === activeTab

        // Professional filter
        const matchesProfessional = professionalFilter === 'all' || appointment.professional_id === professionalFilter

        // Date filter logic
        const appointmentDate = new Date(appointment.appointment_date)
        const today = new Date()
        today.setHours(0, 0, 0, 0)
        const tomorrow = new Date(today)
        tomorrow.setDate(tomorrow.getDate() + 1)
        const weekEnd = new Date(today)
        weekEnd.setDate(weekEnd.getDate() + 7)

        let matchesDate = true
        if (dateFilter === 'today') {
            const appointmentDay = new Date(appointmentDate)
            appointmentDay.setHours(0, 0, 0, 0)
            matchesDate = appointmentDay.getTime() === today.getTime()
        } else if (dateFilter === 'tomorrow') {
            const appointmentDay = new Date(appointmentDate)
            appointmentDay.setHours(0, 0, 0, 0)
            matchesDate = appointmentDay.getTime() === tomorrow.getTime()
        } else if (dateFilter === 'week') {
            matchesDate = appointmentDate >= today && appointmentDate <= weekEnd
        }

        return matchesSearch && matchesTab && matchesDate && matchesProfessional
    })

    const getTabCount = (tabId: string) => {
        if (tabId === 'all') return appointments.length
        return appointments.filter((a) => a.status === tabId).length
    }

    const formatDate = (date: string) => {
        const d = new Date(date)
        return d.toLocaleDateString('es-MX', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
        })
    }

    const formatTime = (date: string) => {
        const d = new Date(date)
        return d.toLocaleTimeString('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
        })
    }

    const getStatusIcon = (status: string) => {
        switch (status) {
            case 'confirmed':
                return <CheckCircle2 className="w-4 h-4 text-emerald-600" />
            case 'pending':
                return <AlertCircle className="w-4 h-4 text-amber-600" />
            case 'cancelled':
                return <XCircle className="w-4 h-4 text-red-600" />
            case 'completed':
                return <CheckCircle2 className="w-4 h-4 text-primary-600" />
            default:
                return null
        }
    }

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-[400px]">
                <Loader2 className="w-8 h-8 animate-spin text-primary-500" />
            </div>
        )
    }

    // Map appointments to calendar events
    const mappedAppointments = appointments.map(apt => {
        // Validation
        if (!apt.appointment_date) return null

        let start: Date

        // Check if we have an explicit time column (newer records)
        // If appointment_time is present and not just "00:00" or empty
        const hasExplicitTime = apt.appointment_time && apt.appointment_time !== '00:00' && apt.appointment_time !== '00:00:00';

        if (hasExplicitTime) {
            // Safe extraction of YYYY-MM-DD
            const datePart = apt.appointment_date.split('T')[0].split(' ')[0]

            // Ensure HH:mm format (sanitize)
            let timeStr = apt.appointment_time || '00:00'
            const timeParts = timeStr.split(':')
            const hour = (timeParts[0] || '00').padStart(2, '0')
            const minute = (timeParts[1] || '00').padStart(2, '0')
            const safeTimeStr = `${hour}:${minute}`

            start = new Date(`${datePart}T${safeTimeStr}:00`)
        } else {
            // Fallback: Try parsing appointment_date directly (legacy records often include time)
            // e.g. "2026-02-18T09:30:00"
            start = new Date(apt.appointment_date)
        }

        // Debug check for invalid dates
        if (isNaN(start.getTime())) {
            console.error('Invalid Date created for:', apt)
            return null
        }

        // Find service duration
        const service = services.find(s => s.name === apt.service)
        const duration = service ? service.duration : 60
        const end = new Date(start.getTime() + (duration * 60 * 1000))

        // Get professional color
        const prof = apt.professional_id ? professionals.find(p => p.member_id === apt.professional_id) : null

        return {
            id: apt.id,
            title: `${apt.patient_name} - ${apt.service}`,
            start,
            end,
            resource: {
                type: 'local',
                ...apt,
                professionalColor: prof?.color || undefined,
                professionalName: prof ? `${prof.first_name || ''} ${prof.last_name || ''}`.trim() : undefined
            }
        }
    }).filter(Boolean) as CalendarEvent[]



    return (
        <div className="space-y-6 animate-fade-in pb-20">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-semibold text-charcoal">Citas</h1>
                    <p className="text-charcoal/50 mt-1">Gestiona todas las citas de tu clínica</p>
                </div>
                <button
                    onClick={() => {
                        const now = new Date()
                        setNewAppointment({
                            patient_name: '',
                            phone_number: '',
                            service: '',
                            appointment_date: format(now, 'yyyy-MM-dd'),
                            appointment_time: '09:00',
                            notes: '',
                            professional_id: ''
                        })
                        setShowModal(true)
                    }}
                    className="btn-primary flex items-center gap-2"
                >
                    <Plus className="w-5 h-5" />
                    Nueva Cita
                </button>
            </div>

            {/* Filters */}
            <div className="card-soft p-4">
                <div className="flex items-center gap-4">
                    {/* Search */}
                    <div className="flex-1 relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-charcoal/40" />
                        <input
                            type="text"
                            placeholder="Buscar por nombre, servicio o teléfono..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full pl-10 pr-4 py-2.5 bg-ivory border border-silk-beige rounded-soft text-sm placeholder:text-charcoal/40 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"
                        />
                    </div>

                    {/* Date Filter */}
                    <div className="relative">
                        <button
                            onClick={() => setShowDatePicker(!showDatePicker)}
                            className={cn(
                                "flex items-center gap-2 px-4 py-2.5 border rounded-soft text-sm transition-colors",
                                dateFilter !== 'all'
                                    ? "bg-primary-50 border-primary-300 text-primary-700"
                                    : "bg-ivory border-silk-beige text-charcoal/70 hover:bg-silk-beige/50"
                            )}
                        >
                            <Calendar className="w-4 h-4" />
                            {dateFilter === 'all' ? 'Fecha' :
                                dateFilter === 'today' ? 'Hoy' :
                                    dateFilter === 'tomorrow' ? 'Mañana' : 'Esta Semana'}
                        </button>

                        {showDatePicker && (
                            <div className="absolute top-full left-0 mt-2 bg-white rounded-soft shadow-premium-lg border border-silk-beige py-2 min-w-[150px] z-10">
                                <button
                                    onClick={() => { setDateFilter('all'); setShowDatePicker(false); }}
                                    className={cn(
                                        "w-full px-4 py-2 text-left text-sm hover:bg-ivory transition-colors",
                                        dateFilter === 'all' && "bg-primary-50 text-primary-700"
                                    )}
                                >
                                    Todas las fechas
                                </button>
                                <button
                                    onClick={() => { setDateFilter('today'); setShowDatePicker(false); }}
                                    className={cn(
                                        "w-full px-4 py-2 text-left text-sm hover:bg-ivory transition-colors",
                                        dateFilter === 'today' && "bg-primary-50 text-primary-700"
                                    )}
                                >
                                    Hoy
                                </button>
                                <button
                                    onClick={() => { setDateFilter('tomorrow'); setShowDatePicker(false); }}
                                    className={cn(
                                        "w-full px-4 py-2 text-left text-sm hover:bg-ivory transition-colors",
                                        dateFilter === 'tomorrow' && "bg-primary-50 text-primary-700"
                                    )}
                                >
                                    Mañana
                                </button>
                                <button
                                    onClick={() => { setDateFilter('week'); setShowDatePicker(false); }}
                                    className={cn(
                                        "w-full px-4 py-2 text-left text-sm hover:bg-ivory transition-colors",
                                        dateFilter === 'week' && "bg-primary-50 text-primary-700"
                                    )}
                                >
                                    Esta Semana
                                </button>
                            </div>
                        )}
                    </div>

                    {/* More Filters */}
                    <div className="relative">
                        <button
                            onClick={() => setShowFilters(!showFilters)}
                            className={cn(
                                "flex items-center gap-2 px-4 py-2.5 border rounded-soft text-sm transition-colors",
                                showFilters
                                    ? "bg-primary-50 border-primary-300 text-primary-700"
                                    : "bg-ivory border-silk-beige text-charcoal/70 hover:bg-silk-beige/50"
                            )}
                        >
                            <Filter className="w-4 h-4" />
                            Filtros
                        </button>

                        {showFilters && (
                            <div className="absolute top-full right-0 mt-2 bg-white rounded-soft shadow-premium-lg border border-silk-beige p-4 min-w-[200px] z-10">
                                <p className="text-xs font-medium text-charcoal/50 uppercase mb-3">Ordenar por</p>
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-sm text-charcoal cursor-pointer">
                                        <input type="radio" name="sort" defaultChecked className="accent-primary-500" />
                                        Fecha (más reciente)
                                    </label>
                                    <label className="flex items-center gap-2 text-sm text-charcoal cursor-pointer">
                                        <input type="radio" name="sort" className="accent-primary-500" />
                                        Fecha (más antigua)
                                    </label>
                                    <label className="flex items-center gap-2 text-sm text-charcoal cursor-pointer">
                                        <input type="radio" name="sort" className="accent-primary-500" />
                                        Nombre (A-Z)
                                    </label>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Sync Button - Disabled by user request */}
                    {/* <button
                        onClick={() => setShowSettingsModal(true)}
                        className={cn(
                            "flex items-center gap-2 px-4 py-2.5 border rounded-soft text-sm transition-colors",
                            googleEvents.length > 0
                                ? "bg-white border-silk-beige text-charcoal hover:bg-silk-beige/50"
                                : "bg-ivory border-silk-beige text-charcoal/70 hover:bg-silk-beige/50"
                        )}
                        title="Configurar Sincronización"
                    >
                        <RefreshCw className={cn("w-4 h-4", isSyncing && "animate-spin")} />
                        <span className="hidden sm:inline">Sync</span>
                        {googleEvents.length > 0 && (
                            <span className="w-2 h-2 rounded-full bg-emerald-500" />
                        )}
                    </button> */}

                    {/* View Toggle */}
                    <div className="flex bg-ivory border border-silk-beige rounded-soft p-1">
                        <button
                            onClick={() => setViewMode('list')}
                            className={cn(
                                "p-2 rounded-soft transition-all",
                                viewMode === 'list'
                                    ? "bg-white shadow-soft text-primary-600"
                                    : "text-charcoal/40 hover:text-charcoal"
                            )}
                            title="Vista de Lista"
                        >
                            <LayoutList className="w-4 h-4" />
                        </button>
                        <button
                            onClick={() => setViewMode('calendar')}
                            className={cn(
                                "p-2 rounded-soft transition-all",
                                viewMode === 'calendar'
                                    ? "bg-white shadow-soft text-primary-600"
                                    : "text-charcoal/40 hover:text-charcoal"
                            )}
                            title="Vista de Calendario"
                        >
                            <CalendarIcon className="w-4 h-4" />
                        </button>
                    </div>
                </div>

                {viewMode === 'list' && (
                    <div className="flex gap-2 mt-4 border-t border-silk-beige pt-4">
                        {tabs.map((tab) => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={cn(
                                    'flex items-center gap-2 px-4 py-2 rounded-soft text-sm font-medium transition-colors',
                                    activeTab === tab.id
                                        ? 'bg-primary-500 text-white'
                                        : 'text-charcoal/60 hover:bg-silk-beige/50 hover:text-charcoal'
                                )}
                            >
                                {tab.label}
                                <span
                                    className={cn(
                                        'w-5 h-5 rounded-full flex items-center justify-center text-xs',
                                        activeTab === tab.id ? 'bg-white/20' : 'bg-silk-beige'
                                    )}
                                >
                                    {getTabCount(tab.id)}
                                </span>
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Professional Filter Pills */}
            {professionals.length > 1 && (
                <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-xs font-medium text-charcoal/50 uppercase tracking-wide mr-1">Profesional:</span>
                    <button
                        onClick={() => setProfessionalFilter('all')}
                        className={cn(
                            'px-3 py-1.5 rounded-full text-xs font-medium transition-all border',
                            professionalFilter === 'all'
                                ? 'bg-charcoal text-white border-charcoal'
                                : 'bg-ivory text-charcoal/60 border-silk-beige hover:border-charcoal/30'
                        )}
                    >
                        Todos
                    </button>
                    {professionals.map((prof) => (
                        <button
                            key={prof.member_id}
                            onClick={() => setProfessionalFilter(prof.member_id)}
                            className={cn(
                                'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all border',
                                professionalFilter === prof.member_id
                                    ? 'bg-charcoal text-white border-charcoal'
                                    : 'bg-ivory text-charcoal/60 border-silk-beige hover:border-charcoal/30'
                            )}
                        >
                            <div
                                className="w-2.5 h-2.5 rounded-full flex-shrink-0"
                                style={{ backgroundColor: prof.color || '#8B5CF6' }}
                            />
                            {prof.first_name || prof.email}
                        </button>
                    ))}
                </div>
            )}

            {viewMode === 'calendar' ? (
                <CalendarView
                    onEditEvent={(event) => {
                        // Check if it's a google event
                        if (event.resource?.type === 'google') {
                            // Ideally show a toast
                            console.log('Google event selected, cannot edit directly yet')
                            alert('No se pueden editar eventos de Google directamente desde aquí.')
                            return
                        }
                        setEditingId(event.id)
                        setNewAppointment({
                            patient_name: event.resource.patient_name,
                            phone_number: event.resource.phone_number,
                            service: event.resource.service,
                            appointment_date: format(event.start, 'yyyy-MM-dd'),
                            appointment_time: format(event.start, 'HH:mm'),
                            notes: event.resource.notes || ''
                        })
                        setShowModal(true)
                    }}
                    events={[
                        ...mappedAppointments,
                        // ...googleEvents // Disabled by user request
                    ]}
                    onSelectEvent={(event) => {
                        // Debug log 
                        console.log('Event clicked:', event)

                        // Check if it's a google event to prevent editing (or show info)
                        if (event.resource?.type === 'google') {
                            console.log('Google event selected, cannot edit directly yet')
                            return
                        }

                        // Populate form for editing
                        setEditingId(event.id)
                        setNewAppointment({
                            patient_name: event.resource.patient_name,
                            phone_number: event.resource.phone_number,
                            service: event.resource.service,
                            appointment_date: format(event.start, 'yyyy-MM-dd'),
                            appointment_time: format(event.start, 'HH:mm'),
                            notes: event.resource.notes || ''
                        })
                        setShowModal(true)
                    }}
                    onSelectSlot={(slotInfo) => {
                        setNewAppointment({
                            ...newAppointment,
                            appointment_date: slotInfo.start.toISOString().split('T')[0],
                            appointment_time: slotInfo.start.toTimeString().slice(0, 5)
                        })
                        setShowModal(true)
                    }}
                />
            ) : (
                <>
                    {/* Appointments Table */}
                    <div className="card-soft">
                        <table className="w-full">
                            <thead>
                                <tr className="border-b border-silk-beige bg-ivory/50">
                                    <th className="text-left py-4 px-6 text-sm font-medium text-charcoal/60">Paciente</th>
                                    <th className="text-left py-4 px-6 text-sm font-medium text-charcoal/60">Servicio</th>
                                    <th className="text-left py-4 px-6 text-sm font-medium text-charcoal/60">Fecha y Hora</th>
                                    <th className="text-left py-4 px-6 text-sm font-medium text-charcoal/60">Estado</th>
                                    <th className="text-right py-4 px-6 text-sm font-medium text-charcoal/60">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredAppointments.map((appointment, index) => (
                                    <tr
                                        key={appointment.id}
                                        className={cn(
                                            'border-b border-silk-beige/50 hover:bg-ivory/50 transition-colors',
                                            index === filteredAppointments.length - 1 && 'border-b-0'
                                        )}
                                    >
                                        <td className="py-4 px-6">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-silk-beige rounded-full flex items-center justify-center">
                                                    <User className="w-5 h-5 text-charcoal/50" />
                                                </div>
                                                <div>
                                                    <p className="font-medium text-charcoal">{appointment.patient_name}</p>
                                                    <p className="text-sm text-charcoal/50 flex items-center gap-1">
                                                        <Phone className="w-3 h-3" />
                                                        {formatPhoneNumber(appointment.phone_number)}
                                                    </p>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="py-4 px-6">
                                            <p className="text-charcoal">{appointment.service}</p>
                                            {appointment.notes && (
                                                <p className="text-sm text-charcoal/50 mt-0.5">{appointment.notes}</p>
                                            )}
                                        </td>
                                        <td className="py-4 px-6">
                                            <div className="flex items-center gap-2">
                                                <Calendar className="w-4 h-4 text-charcoal/40" />
                                                <div>
                                                    <p className="text-charcoal capitalize">{formatDate(appointment.appointment_date)}</p>
                                                    <p className="text-sm text-charcoal/50 flex items-center gap-1">
                                                        <Clock className="w-3 h-3" />
                                                        {formatTime(appointment.appointment_date)}
                                                    </p>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="py-4 px-6">
                                            <span className={cn('inline-flex items-center gap-1.5', getStatusColor(appointment.status))}>
                                                {getStatusIcon(appointment.status)}
                                                {getStatusLabel(appointment.status)}
                                            </span>
                                        </td>
                                        <td className="py-4 px-6 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                {appointment.status === 'pending' && (
                                                    <>
                                                        <button
                                                            onClick={() => updateAppointmentStatus(appointment.id, 'confirmed')}
                                                            className="px-3 py-1.5 text-sm font-medium text-emerald-600 bg-emerald-50 hover:bg-emerald-100 rounded-soft transition-colors"
                                                        >
                                                            Confirmar
                                                        </button>
                                                        <button
                                                            onClick={() => updateAppointmentStatus(appointment.id, 'cancelled')}
                                                            className="px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-soft transition-colors"
                                                        >
                                                            Cancelar
                                                        </button>
                                                    </>
                                                )}
                                                {appointment.status === 'confirmed' && (
                                                    <button
                                                        onClick={() => updateAppointmentStatus(appointment.id, 'completed')}
                                                        className="px-3 py-1.5 text-sm font-medium text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-soft transition-colors"
                                                    >
                                                        Completar
                                                    </button>
                                                )}
                                                {appointment.status === 'completed' && (
                                                    <button
                                                        onClick={() => handleSendSurvey(appointment)}
                                                        className="px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-soft transition-colors flex items-center gap-1"
                                                        title="Enviar Encuesta de Satisfacción"
                                                    >
                                                        <MessageCircle className="w-3 h-3" />
                                                        Encuesta
                                                    </button>
                                                )}
                                                {(appointment.status === 'confirmed' || appointment.status === 'pending') && (
                                                    <button
                                                        onClick={() => handleSendReminder(appointment)}
                                                        className="p-2 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-soft transition-colors"
                                                        title="Enviar Recordatorio WhatsApp"
                                                    >
                                                        <MessageCircle className="w-4 h-4" />
                                                    </button>
                                                )}
                                                <div className="relative group">
                                                    <button className="p-2 text-charcoal/50 hover:text-charcoal hover:bg-ivory rounded-soft transition-colors">
                                                        <MoreVertical className="w-4 h-4" />
                                                    </button>

                                                    {/* Dropdown Menu */}
                                                    <div className="absolute right-0 top-full w-48 hidden group-hover:block z-20 pt-1">
                                                        <div className="bg-white rounded-soft shadow-premium border border-silk-beige overflow-hidden">
                                                            <button
                                                                onClick={() => {
                                                                    setEditingId(appointment.id) // Set editing mode
                                                                    setNewAppointment({
                                                                        patient_name: appointment.patient_name,
                                                                        phone_number: appointment.phone_number,
                                                                        service: appointment.service,
                                                                        appointment_date: appointment.appointment_date.split('T')[0],
                                                                        appointment_time: appointment.appointment_date.split('T')[1].slice(0, 5),
                                                                        notes: appointment.notes || ''
                                                                    })
                                                                    setShowModal(true) // Open modal
                                                                }}
                                                                className="w-full text-left px-4 py-2 text-sm text-charcoal hover:bg-gray-50 flex items-center gap-2"
                                                            >
                                                                <Settings className="w-4 h-4" />
                                                                Editar Cita
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteAppointment(appointment)}
                                                                className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                                Eliminar Cita
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        {filteredAppointments.length === 0 && (
                            <div className="py-12 text-center">
                                <Calendar className="w-12 h-12 text-charcoal/20 mx-auto mb-4" />
                                <p className="text-charcoal/50">No se encontraron citas</p>
                            </div>
                        )}
                    </div>

                    {/* Google Calendar Events Section */}
                    {googleEvents.length > 0 && (
                        <div className="card-soft overflow-hidden mt-4">
                            <div className="flex items-center justify-between p-4 border-b border-silk-beige bg-blue-50/50">
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-blue-500" />
                                    <h3 className="font-medium text-charcoal text-sm">Google Calendar</h3>
                                    <span className="text-xs text-charcoal/50 bg-blue-100 px-2 py-0.5 rounded-full">
                                        {googleEvents.length} eventos
                                    </span>
                                </div>
                                <button
                                    onClick={fetchGoogleEvents}
                                    className="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700 transition-colors"
                                >
                                    <RefreshCw className={cn("w-3 h-3")} />
                                    Actualizar
                                </button>
                            </div>
                            <div className="divide-y divide-silk-beige/50">
                                {googleEvents
                                    .filter(event => {
                                        const eventDate = new Date(event.start)
                                        const now = new Date()
                                        now.setHours(0, 0, 0, 0)
                                        return eventDate >= now
                                    })
                                    .sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime())
                                    .slice(0, 10)
                                    .map((event) => (
                                        <div
                                            key={event.id}
                                            className="flex items-center gap-4 p-4 hover:bg-ivory/50 transition-colors"
                                        >
                                            <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0">
                                                <Calendar className="w-5 h-5 text-blue-500" />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className="font-medium text-charcoal truncate">{event.title}</p>
                                                {event.resource?.description && (
                                                    <p className="text-xs text-charcoal/50 truncate mt-0.5">{event.resource.description}</p>
                                                )}
                                            </div>
                                            <div className="text-right flex-shrink-0">
                                                <p className="text-sm text-charcoal capitalize">
                                                    {new Date(event.start).toLocaleDateString('es-MX', {
                                                        weekday: 'short',
                                                        day: 'numeric',
                                                        month: 'short',
                                                    })}
                                                </p>
                                                <p className="text-xs text-charcoal/50 flex items-center gap-1 justify-end">
                                                    <Clock className="w-3 h-3" />
                                                    {event.resource?.isAllDay ? 'Todo el día' : new Date(event.start).toLocaleTimeString('es-MX', {
                                                        hour: '2-digit',
                                                        minute: '2-digit',
                                                    })}
                                                </p>
                                            </div>
                                            {event.resource?.htmlLink && (
                                                <a
                                                    href={event.resource.htmlLink}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="p-2 text-blue-500 hover:text-blue-600 hover:bg-blue-50 rounded-soft transition-colors"
                                                    title="Abrir en Google Calendar"
                                                >
                                                    <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                                        <polyline points="15 3 21 3 21 9" />
                                                        <line x1="10" y1="14" x2="21" y2="3" />
                                                    </svg>
                                                </a>
                                            )}
                                        </div>
                                    ))}
                            </div>
                        </div>
                    )}
                </>
            )
            }

            {/* New Appointment Modal */}
            {
                showModal && createPortal(
                    <div className="fixed inset-0 bg-charcoal/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                        <div className="bg-white rounded-soft shadow-premium-lg w-full max-w-lg animate-scale-in">
                            <div className="flex items-center justify-between p-6 border-b border-silk-beige">
                                <h2 className="text-xl font-bold text-charcoal">
                                    {editingId ? 'Editar Cita' : 'Nueva Cita'}
                                </h2>
                                <button
                                    onClick={() => {
                                        setShowModal(false)
                                        setEditingId(null)
                                        setNewAppointment({
                                            patient_name: '',
                                            phone_number: '',
                                            service: '',
                                            appointment_date: '',
                                            appointment_time: '',
                                            notes: ''
                                        })
                                    }}
                                    className="p-2 hover:bg-ivory rounded-soft transition-colors"
                                >
                                    <X className="w-5 h-5 text-charcoal/50" />
                                </button>
                            </div>

                            <div className="p-6 space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-charcoal mb-2">
                                        Nombre del Paciente *
                                    </label>
                                    <input
                                        type="text"
                                        value={newAppointment.patient_name}
                                        onChange={(e) => setNewAppointment({ ...newAppointment, patient_name: e.target.value })}
                                        placeholder="Ej: María García"
                                        className="input-soft w-full"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-charcoal mb-2">
                                        Teléfono *
                                    </label>
                                    <input
                                        type="tel"
                                        value={newAppointment.phone_number}
                                        onChange={(e) => setNewAppointment({ ...newAppointment, phone_number: e.target.value })}
                                        placeholder="Ej: +52 55 1234 5678"
                                        className="input-soft w-full"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-charcoal mb-2">
                                        Servicio *
                                    </label>
                                    <div className="relative">
                                        <select
                                            value={newAppointment.service}
                                            onChange={(e) => {
                                                setNewAppointment({
                                                    ...newAppointment,
                                                    service: e.target.value
                                                })
                                            }}
                                            className="input-soft w-full appearance-none"
                                        >
                                            <option value="">Selecciona un servicio</option>
                                            {services.map((service) => (
                                                <option key={service.id} value={service.name}>
                                                    {service.name} ({service.duration} min) - ${service.price}
                                                </option>
                                            ))}
                                        </select>
                                        <ChevronRight className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-charcoal/40 rotate-90 pointer-events-none" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-charcoal mb-2">
                                        Profesional
                                    </label>
                                    <div className="relative">
                                        <select
                                            value={newAppointment.professional_id}
                                            onChange={(e) => {
                                                setNewAppointment({
                                                    ...newAppointment,
                                                    professional_id: e.target.value
                                                })
                                            }}
                                            className="input-soft w-full appearance-none"
                                        >
                                            <option value="">Sin asignar</option>
                                            {professionals.map((prof) => (
                                                <option key={prof.member_id} value={prof.member_id}>
                                                    {prof.first_name || ''} {prof.last_name || ''} {prof.job_title ? `(${prof.job_title})` : ''}
                                                </option>
                                            ))}
                                        </select>
                                        <ChevronRight className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-charcoal/40 rotate-90 pointer-events-none" />
                                    </div>
                                    {newAppointment.professional_id && (
                                        <div className="mt-1.5 flex items-center gap-2">
                                            {(() => {
                                                const prof = professionals.find(p => p.member_id === newAppointment.professional_id)
                                                return prof ? (
                                                    <>
                                                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: prof.color || '#8B5CF6' }} />
                                                        <span className="text-xs text-charcoal/60">
                                                            {prof.job_title || prof.specialty || prof.role}
                                                        </span>
                                                    </>
                                                ) : null
                                            })()}
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-charcoal mb-2">
                                            Fecha *
                                        </label>
                                        <input
                                            type="date"
                                            value={newAppointment.appointment_date}
                                            onChange={(e) => setNewAppointment({ ...newAppointment, appointment_date: e.target.value })}
                                            className="input-soft w-full"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-charcoal mb-2">
                                            Hora *
                                        </label>
                                        <div className="flex gap-2">
                                            <select
                                                className="input-soft w-full appearance-none text-center"
                                                value={(() => {
                                                    const [h] = newAppointment.appointment_time.split(':').map(Number)
                                                    if (h === 0) return 12
                                                    if (h > 12) return h - 12
                                                    return h || 12 // Default to 12 if empty/NaN? Actually value should be valid.
                                                })()}
                                                onChange={(e) => {
                                                    const [currentH, currentM] = newAppointment.appointment_time.split(':').map(Number)
                                                    // Determine current AM/PM
                                                    const isPM = currentH >= 12
                                                    let newH = parseInt(e.target.value)

                                                    if (isPM && newH !== 12) newH += 12
                                                    if (!isPM && newH === 12) newH = 0

                                                    setNewAppointment({
                                                        ...newAppointment,
                                                        appointment_time: `${newH.toString().padStart(2, '0')}:${currentM.toString().padStart(2, '0')}`
                                                    })
                                                }}
                                            >
                                                {Array.from({ length: 12 }, (_, i) => i + 1).map(h => (
                                                    <option key={h} value={h}>{h}</option>
                                                ))}
                                            </select>
                                            <select
                                                className="input-soft w-full appearance-none text-center"
                                                value={newAppointment.appointment_time.split(':')[1]}
                                                onChange={(e) => {
                                                    // eslint-disable-next-line @typescript-eslint/no-unused-vars
                                                    const [currentH, _] = newAppointment.appointment_time.split(':').map(Number)
                                                    // Handle NaN minutes if initialization failed

                                                    setNewAppointment({
                                                        ...newAppointment,
                                                        appointment_time: `${currentH.toString().padStart(2, '0')}:${e.target.value}`
                                                    })
                                                }}
                                            >
                                                {['00', '15', '30', '45'].map(m => (
                                                    <option key={m} value={m}>{m}</option>
                                                ))}
                                            </select>
                                            <select
                                                className="input-soft w-[80px] appearance-none text-center bg-primary-50 font-medium text-primary-700 border-primary-200"
                                                value={parseInt(newAppointment.appointment_time.split(':')[0]) >= 12 ? 'PM' : 'AM'}
                                                onChange={(e) => {
                                                    const [currentH, currentM] = newAppointment.appointment_time.split(':').map(Number)
                                                    const newIsPM = e.target.value === 'PM'
                                                    let newH = currentH

                                                    if (newIsPM && currentH < 12) newH += 12
                                                    if (!newIsPM && currentH >= 12) newH -= 12

                                                    setNewAppointment({
                                                        ...newAppointment,
                                                        appointment_time: `${newH.toString().padStart(2, '0')}:${currentM.toString().padStart(2, '0')}`
                                                    })
                                                }}
                                            >
                                                <option value="AM">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-charcoal mb-2">
                                        Notas (opcional)
                                    </label>
                                    <textarea
                                        value={newAppointment.notes}
                                        onChange={(e) => setNewAppointment({ ...newAppointment, notes: e.target.value })}
                                        placeholder="Notas adicionales..."
                                        rows={3}
                                        className="input-soft w-full resize-none"
                                    />
                                </div>
                            </div>

                            <div className="flex justify-between items-center p-6 border-t border-silk-beige">
                                <div>
                                    {editingId && (
                                        <button
                                            onClick={() => {
                                                if (confirm('¿Quieres cancelar esta cita?')) {
                                                    updateAppointmentStatus(editingId, 'cancelled')
                                                    setShowModal(false)
                                                }
                                            }}
                                            className="text-sm text-red-500 hover:text-red-700 font-medium underline decoration-red-200 hover:decoration-red-500 underline-offset-4 transition-all"
                                        >
                                            Cancelar Cita
                                        </button>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowModal(false)
                                            setEditingId(null)
                                            setNewAppointment({
                                                patient_name: '',
                                                phone_number: '',
                                                service: '',
                                                appointment_date: '',
                                                appointment_time: '',
                                                notes: ''
                                            })
                                        }}
                                        className="btn-ghost"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={handleSaveAppointment}
                                        disabled={saving || !newAppointment.patient_name || !newAppointment.phone_number || !newAppointment.service || !newAppointment.appointment_date || !newAppointment.appointment_time}
                                        className="btn-primary flex items-center gap-2"
                                    >
                                        {saving ? (
                                            <><Loader2 className="w-4 h-4 animate-spin" /> Guardando...</>
                                        ) : (
                                            <><Plus className="w-4 h-4" /> {editingId ? 'Guardar Cambios' : 'Crear Cita'}</>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>,
                    document.body
                )
            }
            {/* Clinical Record Modal */}
            {
                showRecordModal && foundPatient && selectedAppointment && (
                    <ClinicalRecordForm
                        patientId={foundPatient.id}
                        record={{
                            id: '', // New record
                            clinic_id: profile!.clinic_id,
                            patient_id: foundPatient.id,
                            date: selectedAppointment.appointment_date.split('T')[0],
                            treatment_name: selectedAppointment.service,
                            description: selectedAppointment.notes || '',
                            notes: '',
                            attachments: [],
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }}
                        onClose={() => {
                            setShowRecordModal(false)
                            setSelectedAppointment(null)
                            setFoundPatient(null)
                        }}
                        onSave={async () => {
                            // Refresh data or show success toast
                            console.log('Record created!')

                            // Update patient stats
                            try {
                                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                                const { error: statsError } = await (supabase as any).rpc('increment_patient_appointments', {
                                    p_patient_id: foundPatient.id,
                                    p_last_appointment: new Date().toISOString()
                                })

                                if (statsError) {
                                    // Fallback to manual update if RPC doesn't exist (it doesn't yet)
                                    // We'll trust the manual update for now as we didn't plan an RPC
                                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                                    const { error: manualError } = await (supabase as any)
                                        .from('patients')
                                        .update({
                                            last_appointment_at: new Date().toISOString(),
                                            // eslint-disable-next-line @typescript-eslint/no-explicit-any
                                            total_appointments: ((foundPatient as any).total_appointments || 0) + 1
                                        })
                                        .eq('id', foundPatient.id)

                                    if (manualError) throw manualError
                                }
                                console.log('Patient stats updated')
                            } catch (err) {
                                console.error('Error updating patient stats:', err)
                            }
                        }}
                    />
                )
            }

            {/* Patient Creation Modal */}
            {
                showPatientModal && selectedAppointment && (
                    <PatientForm
                        patient={{
                            // Pre-fill with appointment data
                            id: '', // New
                            clinic_id: profile!.clinic_id,
                            created_at: '',
                            updated_at: '',
                            total_appointments: 0,
                            last_appointment_at: null,
                            name: selectedAppointment.patient_name,
                            phone_number: selectedAppointment.phone_number,
                            service: selectedAppointment.service,
                            notes: selectedAppointment.notes,
                            email: null,
                            address: null,
                        }}
                        onClose={() => {
                            setShowPatientModal(false)
                            // If closed without saving, we stop the flow
                            if (!foundPatient) setSelectedAppointment(null)
                        }}
                        onSave={(newPatient) => {
                            if (newPatient) {
                                setFoundPatient(newPatient)
                                setShowPatientModal(false)
                                // Continue format flow
                                setTimeout(() => setShowRecordModal(true), 100)
                            }
                        }}
                    />
                )
            }
        </div >
    )
}
